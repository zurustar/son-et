# 要件定義書: スプライトシステム (Sprite System)

## はじめに

このドキュメントは、FILLYエミュレータのスプライトシステムの要件を定義します。スプライトシステムは、すべての描画要素を統一的に管理し、親子関係に基づいた描画順序を実現します。

## 背景

### 現在の問題点

1. **1次元Z順序の制限**: 現在の実装では `CalculateGlobalZOrder(windowZOrder, localZOrder)` で1次元に変換している
2. **タイプ別固定範囲**: キャスト(100-999)、テキスト(1000-)とタイプ別に固定範囲が割り当てられている
3. **描画順序の不自然さ**: テキストは常にキャストより前面になってしまう
4. **操作順序の無視**: 本来は操作順序（PutCast、TextWrite、MovePicの呼び出し順）でZ順序が決まるべき

### 解決方針

すべての描画要素をスプライトとして統一的に扱い、親子関係をポインタのスライスで表現することで、シンプルで直感的な描画順序制御を実現します。数値によるZ順序管理は廃止し、スライスの順序がそのまま描画順序となります。

## 用語集

- **Picture（ピクチャー）**: メモリ上の画像データ。LoadPicやCreatePicで作成される。画面には直接表示されない
- **Sprite（スプライト）**: 画像を保持し、位置・可視性・透明度を持つ描画単位。画面に表示される
- **SpriteManager**: スプライトの作成・管理・描画を行うマネージャー
- **WindowSprite**: ウィンドウを表すスプライト。子スプライトの親となる
- **PictureSprite**: ピクチャを表すスプライト。ピクチャーがウインドウに関連付けられたときに作成される
- **CastSprite**: キャストを表すスプライト。PutCastで作成され、透明色処理をサポート
- **TextSprite**: テキストを表すスプライト。差分抽出方式で作成
- **ShapeSprite**: 図形を表すスプライト
- **Parent_Sprite（親スプライト）**: 他のスプライトを子として持つスプライト
- **Child_Sprite（子スプライト）**: 親スプライトに属するスプライト
- **Sibling_Sprite（兄弟スプライト）**: 同じ親を持つスプライト
- **Root_Sprite（ルートスプライト）**: 親を持たないトップレベルのスプライト（デスクトップ直下）
- **差分抽出**: テキスト描画時にアンチエイリアスを除去するための手法

### PictureとSpriteの関係

FILLYでは、PictureとSpriteは明確に区別されます：

- **Picture**: メモリ上の画像データ。LoadPicで読み込み、CreatePicで生成する。画面には直接表示されない
- **Sprite**: 画面に表示される描画単位。OpenWin、PutCast、MovePic等で作成される

**重要**: PutCastの引数は以下の通り：
- 第1引数: ソースピクチャーID（画像の取得元）
- 第2引数: 配置先ピクチャーID（キャストを配置する先）

```
例（y_saruサンプルより）:
base_pic = CreatePic(25);           // 新しいピクチャーを作成（ID=27が返される）
OpenWin(base_pic, ...);             // ウインドウを開く
PutCast(25, base_pic, 0, 0);        // ソース=25、配置先=base_pic(27)
cast = PutCast(17, base_pic, ...);  // ソース=17、配置先=base_pic(27)
```

## 要件

---

### 第1部: スプライトの基本定義

---

### 要件1: 汎用スプライト

**ユーザーストーリー:** 開発者として、すべての描画要素を統一的なスプライトとして扱いたい。そうすることで、コードの重複を減らし、保守性を向上させられる。

#### 受け入れ基準

1.1. THE Sprite SHALL 一意のIDを持つ
1.2. THE Sprite SHALL *ebiten.Image を保持する
1.3. THE Sprite SHALL 位置（X, Y座標）を持つ
1.4. THE Sprite SHALL 可視性フラグを持つ
1.5. THE Sprite SHALL 透明度（0.0〜1.0）を持つ
1.6. THE Sprite SHALL 親スプライトへのポインタを持つ（nilの場合はルートスプライト）
1.7. THE Sprite SHALL 子スプライトのスライスを持つ（スライスの順序が描画順序）

### 要件2: 親子関係

**ユーザーストーリー:** 開発者として、スプライト間に親子関係を設定したい。そうすることで、ウインドウとその内容物の関係を自然に表現できる。

#### 受け入れ基準

2.1. WHEN 子スプライトの絶対位置を計算するとき THEN THE System SHALL 親の位置を加算する
2.2. WHEN 子スプライトの実効透明度を計算するとき THEN THE System SHALL 親の透明度を乗算する
2.3. WHEN 親スプライトが非表示のとき THEN THE System SHALL 子スプライトも非表示として扱う
2.4. THE Sprite SHALL 親を変更できる
2.5. WHEN 子スプライトが追加されたとき THEN THE System SHALL スライスの末尾に追加する（最前面に配置）
2.6. THE System SHALL 親子関係の深さに制限を設けない（n次元の階層をサポート）

### 要件3: スプライトマネージャー

**ユーザーストーリー:** 開発者として、スプライトを一元管理したい。そうすることで、スプライトの検索が容易になる。

#### 受け入れ基準

3.1. THE SpriteManager SHALL スプライトを作成できる
3.2. THE SpriteManager SHALL 指定サイズの空のスプライトを作成できる
3.3. THE SpriteManager SHALL IDでスプライトを取得できる
3.4. THE SpriteManager SHALL スプライトを削除できる
3.5. THE SpriteManager SHALL すべてのスプライトをクリアできる
3.6. THE SpriteManager SHALL 登録されているスプライト数を返せる
3.7. THE SpriteManager SHALL ルートスプライトのリストを管理する

---

### 第2部: スプライトタイプ

---

### 要件4: ウインドウスプライト

**ユーザーストーリー:** 開発者として、仮想ウインドウをスプライトとして表現したい。そうすることで、ウインドウとその内容物を親子関係で管理できる。

#### 受け入れ基準

4.1. THE System SHALL 指定サイズ・背景色のウインドウスプライトを作成できる
4.2. THE System SHALL ウインドウスプライトを親として子スプライトを追加できる
4.3. WHEN ウインドウが閉じられたとき THEN THE System SHALL ウインドウとその子スプライトを削除する

### 要件5: ピクチャスプライト

**ユーザーストーリー:** 開発者として、BMPファイルをスプライトとして表示したい。そうすることで、FILLYのピクチャ機能を実現できる。

#### 受け入れ基準

5.1. THE System SHALL BMPファイルからスプライトを作成できる
5.2. THE System SHALL 透明色を指定できる
5.3. THE System SHALL ピクチャの一部を切り出してスプライトにできる

### 要件6: キャストスプライト

**ユーザーストーリー:** 開発者として、キャスト（アニメーションスプライト）を表現したい。そうすることで、FILLYのキャスト機能を実現できる。

#### 受け入れ基準

6.1. THE System SHALL キャストをスプライトとして作成できる
6.2. THE System SHALL キャストの位置を移動できる（残像なし）
6.3. THE System SHALL キャストを削除できる
6.4. THE System SHALL 透明色処理をサポートする

### 要件7: テキストスプライト（差分抽出方式）

**ユーザーストーリー:** 開発者として、テキストをアンチエイリアスなしで描画したい。そうすることで、FILLYの見た目を正確に再現できる。

#### 受け入れ基準

7.1. THE System SHALL 背景色の上にテキストを描画し、差分を抽出する
7.2. THE System SHALL 差分抽出結果を透過スプライトとして生成する
7.3. THE System SHALL テキストの色を指定できる
7.4. THE System SHALL 複数のテキストを重ねて描画できる
7.5. WHEN 同じ位置に異なるテキストを描画したとき THEN THE System SHALL 前のテキストの影を残さない

### 要件8: 図形スプライト

**ユーザーストーリー:** 開発者として、図形（線、矩形、円など）をスプライトとして描画したい。そうすることで、FILLYの描画機能を実現できる。

#### 受け入れ基準

8.1. THE System SHALL 線を描画したスプライトを作成できる
8.2. THE System SHALL 矩形を描画したスプライトを作成できる
8.3. THE System SHALL 塗りつぶし矩形を描画したスプライトを作成できる

---

### 第3部: 描画順序システム

---

### 要件9: スライスベースの描画順序

**ユーザーストーリー:** 開発者として、スプライトの描画順序をスライスの順序で管理したい。そうすることで、シンプルで直感的な描画順序制御を実現できる。

#### 受け入れ基準

9.1. THE System SHALL 子スプライトのスライス順序を描画順序として使用する
9.2. THE System SHALL スライスの先頭から順に描画する（先頭が最背面、末尾が最前面）
9.3. WHEN 子スプライトが追加されたとき THEN THE System SHALL スライスの末尾に追加する
9.4. THE System SHALL 数値によるZ順序管理を使用しない

### 要件10: 親子関係に基づく描画順序

**ユーザーストーリー:** 開発者として、親スプライトの子が親の描画後に描画されるようにしたい。そうすることで、ウィンドウの内容がウィンドウの上に正しく表示される。

#### 受け入れ基準

10.1. WHEN 描画が行われるとき THEN THE System SHALL 親スプライトを先に描画し、その後に子スプライトを描画する
10.2. WHEN 同じ親を持つ子スプライトを描画するとき THEN THE System SHALL スライス順で描画する
10.3. THE System SHALL 任意の深さの親子関係に対応する
10.4. WHEN 親スプライトが非表示のとき THEN THE System SHALL 子スプライトも描画しない

### 要件11: ウィンドウ間の描画順序

**ユーザーストーリー:** 開発者として、前面のウィンドウの内容が背面のウィンドウの内容を完全に覆い隠すようにしたい。そうすることで、ウィンドウの重なりが正しく表現される。

#### 受け入れ基準

11.1. THE System SHALL ウィンドウをルートスプライトとして扱う
11.2. WHEN ウィンドウAがウィンドウBより前面にあるとき THEN THE System SHALL ウィンドウAのすべての子スプライトをウィンドウBのすべての子スプライトより後に描画する
11.3. THE System SHALL ルートスプライトのスライス順序でウィンドウの描画順序を決定する

### 要件12: 動的な描画順序変更

**ユーザーストーリー:** 開発者として、スプライトの描画順序を動的に変更したい。そうすることで、スプライトを前面や背面に移動できる。

#### 受け入れ基準

12.1. THE System SHALL スプライトを最前面に移動するメソッドを提供する（スライス末尾に移動）
12.2. THE System SHALL スプライトを最背面に移動するメソッドを提供する（スライス先頭に移動）
12.3. WHEN スプライトの描画順序が変更されたとき THEN THE System SHALL 親のchildrenスライスを更新する

---

### 第4部: ピクチャとスプライトの統合

---

### 要件13: ピクチャのスプライト化

**ユーザーストーリー:** 開発者として、ピクチャをロードした時点でスプライトとして管理したい。そうすることで、ウインドウに関連付けられる前でもキャストやテキストの親として機能できる。

#### 背景

FILLYでは以下のパターンが存在する：
1. ピクチャをロード（LoadPic）してからウインドウに関連付ける（SetPic）
2. ウインドウに関連付けられていないピクチャにテキストを描画し、MovePicで転送する
3. キャストやテキストはピクチャ番号を指定して配置される

#### 受け入れ基準

13.1. WHEN LoadPicが呼び出されたとき THEN THE System SHALL 非表示のPictureSpriteを作成する
13.2. THE PictureSprite SHALL ピクチャ番号をキーとして管理される
13.3. WHEN SetPicが呼び出されたとき THEN THE System SHALL 既存のPictureSpriteをウインドウの子として関連付ける
13.4. WHEN SetPicが呼び出されたとき THEN THE System SHALL PictureSpriteを表示状態にする
13.5. WHEN ウインドウに関連付けられていないピクチャにCastSetが呼び出されたとき THEN THE System SHALL キャストをそのピクチャのPictureSpriteの子として管理する
13.6. WHEN ウインドウに関連付けられていないピクチャにTextWriteが呼び出されたとき THEN THE System SHALL テキストをそのピクチャのPictureSpriteの子として管理する
13.7. WHEN ピクチャが解放されたとき THEN THE System SHALL 対応するPictureSpriteとその子スプライトを削除する

### 要件14: ピクチャスプライトの状態管理

**ユーザーストーリー:** 開発者として、ピクチャスプライトの状態（表示/非表示、ウインドウ関連付け）を追跡したい。そうすることで、適切なタイミングで描画できる。

#### 受け入れ基準

14.1. THE PictureSprite SHALL 「未関連付け」「関連付け済み」の状態を持つ
14.2. WHEN PictureSpriteが「未関連付け」状態のとき THEN THE System SHALL そのスプライトを描画しない
14.3. WHEN PictureSpriteが「関連付け済み」状態のとき THEN THE System SHALL 親ウインドウの可視性に従って描画する
14.4. THE System SHALL ピクチャ番号からPictureSpriteを効率的に検索できる
14.5. WHEN MovePicが呼び出されたとき THEN THE System SHALL 転送先ピクチャのPictureSpriteの画像を更新する
14.6. WHEN TextWriteが呼び出されたとき THEN THE System SHALL 対象ピクチャのPictureSpriteの画像を更新する

### 要件15: ピクチャ内のスプライト

**ユーザーストーリー:** 開発者として、ピクチャの中にキャストやテキストを配置したい。そうすることで、複雑な階層構造を表現できる。

#### 受け入れ基準

15.1. THE PictureSprite SHALL 子スプライトを持てる
15.2. WHEN ピクチャ内にキャストが配置されたとき THEN THE System SHALL キャストをピクチャの子スプライトとして管理する
15.3. WHEN ピクチャ内にテキストが配置されたとき THEN THE System SHALL テキストをピクチャの子スプライトとして管理する
15.4. THE System SHALL ピクチャの移動時に子スプライトも一緒に移動する

### 要件16: スプライトシステム完全統合

**ユーザーストーリー:** 開発者として、すべての描画をスプライトシステム経由で行いたい。そうすることで、描画の一貫性を保ち、描画順序の問題を解消できる。

#### 受け入れ基準

16.1. WHEN MovePicが呼び出されたとき THEN THE System SHALL ピクチャー画像への直接描画を行わず、PictureSpriteのみを作成する
16.2. WHEN Draw()が呼び出されたとき THEN THE System SHALL スプライトシステムのみを使用して描画する
16.3. THE System SHALL ピクチャー画像への焼き付けを廃止する
16.4. THE System SHALL すべての描画要素をスプライトとして管理する

### 要件17: ピクチャースプライトの融合

**ユーザーストーリー:** 開発者として、同じ領域に重なるピクチャースプライトを融合したい。そうすることで、スプライト数を削減し、パフォーマンスを向上させられる。

#### 受け入れ基準

17.1. WHEN 同じピクチャーIDに対してMovePicが複数回呼び出されたとき THEN THE System SHALL 既存のPictureSpriteに画像を合成できる
17.2. THE PictureSpriteManager SHALL 融合可能なスプライトを検索できる
17.3. THE PictureSprite SHALL 新しい画像を既存の画像に合成できる
17.4. WHEN 融合が行われたとき THEN THE System SHALL スプライトの領域を適切に拡張する
17.5. THE System SHALL 融合によりスプライト数を削減する

---

### 第5部: パフォーマンスと互換性

---

### 要件18: パフォーマンス

**ユーザーストーリー:** 開発者として、スプライトシステムが効率的に動作するようにしたい。そうすることで、60FPSでのスムーズな描画を維持できる。

#### 受け入れ基準

18.1. THE System SHALL スライスベースの描画順序により、ソート処理を不要にする
18.2. THE System SHALL 再帰的な描画により、親子関係を効率的に処理する
18.3. THE System SHALL スレッドセーフな操作を提供する

### 要件19: 既存システムとの互換性

**ユーザーストーリー:** 開発者として、既存のFILLYスクリプトが正しく動作し続けるようにしたい。そうすることで、既存のタイトルを壊さずに改善できる。

#### 受け入れ基準

19.1. THE System SHALL 既存のスプライトAPIを維持する
19.2. THE System SHALL 既存のウィンドウ管理APIを維持する
19.3. WHEN 既存のスクリプトが実行されたとき THEN THE System SHALL 同等の描画結果を生成する

### 要件20: デバッグ支援

**ユーザーストーリー:** 開発者として、スプライト階層の状態を確認したい。そうすることで、描画順序の問題をデバッグできる。

#### 受け入れ基準

20.1. THE System SHALL スプライト階層をツリー形式で出力できる
20.2. THE System SHALL 描画順序のリストを出力できる
20.3. WHEN デバッグモードが有効なとき THEN THE System SHALL スプライト情報をオーバーレイ表示できる
