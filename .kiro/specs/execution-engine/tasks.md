# 実装計画: 実行エンジン (Execution Engine)

## 概要

この実装計画は、Toffyスクリプト言語の実行エンジンを段階的に構築します。コンパイラが生成したOpCodeを実行し、イベントドリブンなスクリプトの動作を実現します。

実装は5つのフェーズに分かれており、各フェーズは前のフェーズの成果物に依存します。

## タスク

- [x] 1. フェーズ1: コアシステムの実装
  - [x] 1.1 VM基本構造の実装
    - pkg/vm/vm.goを作成
    - VM構造体を定義（opcodes、pc、globalScope、localScope、callStack、running等）
    - New関数を実装（オプションパターンでheadless、timeout等を設定）
    - Run、Stop、Execute基本メソッドを実装
    - _要件: 8.1, 14.1, 14.2_
  
  - [x] 1.2 スコープ管理の実装
    - pkg/vm/scope.goを作成
    - Scope構造体を定義（variables map、parent、sync.RWMutex）
    - NewScope、Get、Set、GetLocal、SetLocal実装
    - StackFrame構造体を定義
    - _要件: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8_
  
  - [x] 1.3 スコープ管理のプロパティテスト
    - **プロパティ16: グローバル変数のスコープ**
    - **プロパティ17: スコープのラウンドトリップ**
    - **プロパティ18: 変数解決の優先順位**
    - **検証: 要件 9.1, 9.3, 9.4, 9.5**
  
  - [x] 1.4 基本OpCode実行の実装
    - pkg/vm/executor.goを作成
    - OpAssign実装（変数代入）
    - OpCall実装（関数呼び出し、組み込み関数レジストリ）
    - OpBinaryOp実装（+, -, *, /, %, ==, !=, <, <=, >, >=, &&, ||）
    - OpUnaryOp実装（-, !）
    - OpArrayAccess実装（配列要素アクセス）
    - OpArrayAssign実装（配列要素代入）
    - _要件: 8.2, 8.3, 8.4, 8.11, 8.12, 8.13_
  
  - [x] 1.5 基本OpCode実行のプロパティテスト
    - **プロパティ13: OpCode順次実行**
    - **プロパティ14: 変数代入の正確性**
    - **プロパティ15: 二項演算の正確性**
    - **検証: 要件 8.1, 8.2, 8.11**
  
  - [x] 1.6 制御フローOpCodeの実装
    - OpIf実装（条件分岐）
    - OpFor実装（forループ）
    - OpWhile実装（whileループ）
    - OpSwitch実装（switch文）
    - OpBreak実装（ループ脱出）
    - OpContinue実装（次の反復）
    - _要件: 8.5, 8.6, 8.7, 8.8, 8.9, 8.10_
  
  - [x] 1.7 関数呼び出しとスタック管理の実装
    - OpDefineFunction実装（関数定義）
    - 関数呼び出し時のスタックフレーム管理
    - 戻り値の処理
    - 再帰呼び出しのサポート
    - スタックオーバーフロー検出（最大1000フレーム）
    - _要件: 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8_
  
  - [x] 1.8 スタック管理のプロパティテスト
    - **プロパティ23: スタックフレームのラウンドトリップ**
    - **検証: 要件 20.1, 20.2**
  
  - [x] 1.9 配列のサポート実装
    - 配列の動的割り当て
    - 配列の自動拡張（範囲外アクセス時）
    - 配列の参照渡し
    - 配列要素の初期化（ゼロ）
    - _要件: 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8_
  
  - [x] 1.10 配列のプロパティテスト
    - **プロパティ21: 配列の自動拡張**
    - **プロパティ22: 配列の参照渡し**
    - **検証: 要件 19.5, 19.8**

- [x] 2. チェックポイント1 - コアシステムの動作確認
  - すべてのテストが通ることを確認
  - 基本的なOpCode実行が動作することを確認
  - 質問があればユーザーに確認

- [x] 3. フェーズ2: イベントシステムの実装
  - [x] 3.1 イベント基本構造の実装
    - pkg/vm/event.goを作成
    - EventType定義（TIME、MIDI_TIME、MIDI_END、LBDOWN、RBDOWN、RBDBLCLK）
    - Event構造体を定義（Type、Timestamp、Params）
    - _要件: 1.7_
  
  - [x] 3.2 イベントキューの実装
    - EventQueue構造体を定義（events slice、sync.Mutex）
    - Push、Pop、Peek、Len実装
    - 時系列順ソート（タイムスタンプ昇順）
    - キューサイズ制限（デフォルト1000）
    - _要件: 1.1, 1.2, 14.7, 14.8_
  
  - [x] 3.3 イベントキューのプロパティテスト
    - **プロパティ1: イベントキューの時系列順序保証**
    - **プロパティ2: イベントタイムスタンプの自動割り当て**
    - **検証: 要件 1.1, 1.2, 1.3**
  
  - [x] 3.4 イベントハンドラの実装
    - EventHandler構造体を定義（ID、EventType、OpCodes、Active、StepCounter、WaitCounter）
    - Execute、Remove実装
    - イベントパラメータ（MesP1、MesP2、MesP3）のアクセス機構
    - _要件: 1.6, 2.9, 2.11_
  
  - [x] 3.5 ハンドラレジストリの実装
    - HandlerRegistry構造体を定義（handlers map、sync.RWMutex）
    - Register、Unregister、UnregisterAll、GetHandlers実装
    - 登録順序の保持
    - _要件: 1.5, 2.1, 2.10_
  
  - [x] 3.6 ハンドラレジストリのプロパティテスト
    - **プロパティ3: ハンドラの完全呼び出し**
    - **プロパティ4: ハンドラの登録順実行**
    - **プロパティ5: イベントパラメータのアクセス可能性**
    - **プロパティ6: ハンドラ登録の成功**
    - **プロパティ7: del_meによるハンドラ削除**
    - **プロパティ8: del_allによる全ハンドラ削除**
    - **検証: 要件 1.4, 1.5, 1.6, 2.1, 2.9, 2.10**
  
  - [x] 3.7 イベントディスパッチャの実装
    - EventDispatcher構造体を定義（queue、registry、logger）
    - Dispatch実装（イベントを適切なハンドラに配信）
    - ProcessQueue実装（キューからイベントを取り出して処理）
    - _要件: 1.3, 1.4, 14.3_
  
  - [x] 3.8 OpRegisterEventHandlerの実装
    - mes()構文のサポート
    - イベントタイプとOpCodeブロックの登録
    - ネストされたハンドラ登録のサポート
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_
  
  - [x] 3.9 イベントループの実装
    - VMのRun()メソッドにイベントループを統合
    - イベントキューが空の場合の待機
    - OpCode実行と待機ポイントの制御
    - _要件: 14.1, 14.2, 14.4, 14.5, 14.6_

- [x] 4. チェックポイント2 - イベントシステムの動作確認
  - すべてのテストが通ることを確認
  - イベント登録と配信が動作することを確認
  - 質問があればユーザーに確認

- [x] 5. フェーズ3: オーディオシステムの実装
  - [x] 5.1 Timerの実装
    - pkg/vm/audio/timer.goを作成
    - Timer構造体を定義（interval、eventSystem、ticker、running）
    - Start、Stop実装
    - TIMEイベントの定期生成（デフォルト50ms）
    - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [x] 5.2 MIDI Playerの実装
    - pkg/vm/audio/midi.goを作成
    - MIDIPlayer構造体を定義（soundFont、synth、sequencer、audioCtx、player、stream、tickCalc）
    - NewMIDIPlayer実装（go-meltysynthの初期化、SoundFont読み込み）
    - MIDIStream実装（io.Readerインターフェース、sequencer.Render()でオーディオ生成）
    - Play、Stop、IsPlaying実装
    - _要件: 4.1, 4.7, 4.8, 4.9, 4.10_
  
  - [x] 5.3 テンポマップ抽出の実装
    - MIDIファイルからテンポイベントを抽出
    - PPQ（ticks per quarter note）の取得
    - TempoEvent構造体（Tick、MicrosPerBeat）
    - _要件: 4.2_
  
  - [x] 5.4 TickCalculatorの実装
    - TickCalculator構造体を定義（ppq、tempoMap、sampleAtTempo）
    - precalculate実装（各テンポ変更点でのサンプル数を事前計算）
    - TickFromSamples実装（サンプル数からMIDIティックを計算）
    - FillyTickFromSamples実装（サンプル数からFILLYティック（32分音符単位）を計算）
    - _要件: 18.1, 18.2, 18.3, 18.4, 18.5_
  
  - [x] 5.5 MIDI_TIMEイベント生成の実装
    - Update()メソッド実装（ゲームループから呼び出し）
    - player.Position()でオーディオ再生位置を取得
    - TickCalculatorでティックに変換
    - ティックが進んだらMIDI_TIMEイベントを生成
    - _要件: 4.3, 4.4_
  
  - [x] 5.6 MIDI_ENDイベント生成の実装
    - MIDI再生完了の検出（position >= duration）
    - MIDI_ENDイベントの生成
    - _要件: 4.5_
  
  - [x] 5.7 MIDI再生の排他制御実装
    - 新しいMIDI再生時に前のMIDIを停止
    - _要件: 4.6_
  
  - [x] 5.8 MIDI再生のプロパティテスト
    - **プロパティ20: MIDI再生の排他性**
    - **検証: 要件 4.6**
  
  - [x] 5.9 WAV Playerの実装
    - pkg/vm/audio/wav.goを作成
    - WAVPlayer構造体を定義（audioCtx、players、muted）
    - NewWAVPlayer実装（Ebitengine/audioコンテキストを共有）
    - Play実装（WAVファイルの読み込みと再生）
    - 複数ストリームの同時再生サポート（Ebitengine/audioが自動ミキシング）
    - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_
  
  - [x] 5.10 Audio System統合
    - pkg/vm/audio/audio.goを作成
    - AudioSystem構造体を定義（midiPlayer、wavPlayer、timer、audioCtx）
    - NewAudioSystem実装（Ebitengine/audioコンテキストを作成・共有）
    - PlayMIDI、PlayWAVE、SetMuted、Shutdown実装
    - Update()実装（ゲームループから呼び出し、MIDI_TIMEイベント生成）
    - VMへの統合
  
  - [x] 5.11 組み込み関数の登録
    - PlayMIDI組み込み関数を登録
    - PlayWAVE組み込み関数を登録
    - _要件: 10.1, 10.2_

- [x] 6. チェックポイント3 - オーディオシステムの動作確認
  - すべてのテストが通ることを確認
  - MIDI/WAV再生が動作することを確認
  - MIDI_TIMEイベントが生成されることを確認
  - 質問があればユーザーに確認

- [x] 7. フェーズ4: ステップ実行の実装
  - [x] 7.1 OpSetStepの実装
    - ステップカウンタの初期化
    - StepState構造体の管理
    - _要件: 6.1_
  
  - [x] 7.2 OpSetStepのプロパティテスト
    - **プロパティ9: ステップカウンタの初期化**
    - **検証: 要件 6.1**
  
  - [x] 7.3 OpWaitの実装
    - 次のイベントまで実行を一時停止
    - WaitCounterの管理
    - イベント発生時の次ステップへの進行
    - _要件: 6.2, 6.3_
  
  - [x] 7.4 ステップ実行のプロパティテスト
    - **プロパティ10: イベントごとのステップ進行**
    - **検証: 要件 6.3**
  
  - [x] 7.5 連続カンマのサポート
    - 連続カンマの検出
    - 複数イベント待機の実装
    - _要件: 6.5, 6.6_
  
  - [x] 7.6 連続カンマのプロパティテスト
    - **プロパティ11: 連続カンマの待機**
    - **検証: 要件 6.6**
  
  - [x] 7.7 end_step組み込み関数の実装
    - ステップブロックの終了
    - _要件: 6.7, 10.6_
  
  - [x] 7.8 Wait()組み込み関数の実装
    - 指定ステップ数の待機
    - mes(TIME)とmes(MIDI_TIME)での動作
    - _要件: 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 17.7_
  
  - [x] 7.9 Wait()関数のプロパティテスト
    - **プロパティ12: Wait(n)の待機**
    - **検証: 要件 17.1**

- [x] 8. チェックポイント4 - ステップ実行の動作確認
  - すべてのテストが通ることを確認
  - step()構文が動作することを確認
  - Wait()関数が動作することを確認
  - 質問があればユーザーに確認

- [x] 9. フェーズ5: エラーハンドリングとデバッグ
  - [x] 9.1 エラーハンドリングの実装
    - pkg/vm/error.goを作成
    - 致命的エラーと非致命的エラーの分類
    - エラーログの記録
    - ゼロ除算のハンドリング（エラーログ + ゼロ返却）
    - 配列範囲外アクセスのハンドリング（エラーログ + ゼロ返却）
    - ファイル未検出のハンドリング（エラーログ + 実行継続）
    - 未定義変数のハンドリング（デフォルト値で作成）
    - 未定義関数のハンドリング（エラーログ + 実行継続）
    - _要件: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8_
  
  - [x] 9.2 エラーハンドリングのプロパティテスト
    - **プロパティ19: エラー後の実行継続**
    - **検証: 要件 11.8**
  
  - [x] 9.3 デバッグモードの実装
    - ログレベルの設定（debug、info、warn、error）
    - OpCode実行のログ記録
    - イベントディスパッチのログ記録
    - ハンドラ登録/削除のログ記録
    - 変数代入のログ記録
    - 関数呼び出しのログ記録
    - タイムスタンプの追加
    - _要件: 16.1, 16.2, 16.3, 16.4, 16.5, 16.6, 16.7, 16.8_
  
  - [x] 9.4 ヘッドレスモードの実装
    - コマンドラインフラグのサポート（--headless）
    - 環境変数のサポート（HEADLESS=1）
    - オーディオシステムの初期化（ミュート設定）
    - MIDI_TIMEイベントの通常生成
    - 描画操作のスキップとログ記録
    - タイムスタンプ付きログ
    - _要件: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8_
  
  - [x] 9.5 タイムアウト機能の実装
    - コマンドラインフラグのサポート（--timeout）
    - 指定時間後の自動終了
    - リソースのクリーンアップ
    - タイムアウトメッセージのログ記録
    - _要件: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6_
  
  - [x] 9.6 プログラム終了の実装
    - ExitTitle組み込み関数の実装
    - オーディオ再生の停止
    - ウィンドウのクローズ（描画系実装後）
    - リソースのクリーンアップ
    - イベントループの終了
    - グレースフルシャットダウン
    - _要件: 10.7, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7_
  
  - [x] 9.7 del_me、del_us、del_all組み込み関数の実装
    - del_me実装（現在のハンドラ削除）
    - del_us実装（del_meと同じ）
    - del_all実装（全ハンドラ削除）
    - _要件: 10.3, 10.4, 10.5_

- [x] 10. チェックポイント5 - 最終動作確認
  - すべてのテストが通ることを確認
  - エラーハンドリングが動作することを確認
  - ヘッドレスモードが動作することを確認
  - タイムアウト機能が動作することを確認
  - 質問があればユーザーに確認

- [x] 11. 統合とワイヤリング
  - [x] 11.1 VMとアプリケーションの統合
    - pkg/app/app.goにVM統合
    - コンパイル後のOpCodeをVMに渡す
    - VM実行の開始
    - _要件: 13.1, 13.2, 13.3_
  
  - [x] 11.2 サンプルスクリプトでの動作確認
    - samples/kuma2/KUMA2.TFYで動作確認
    - samples/home/home.tfyで動作確認
    - MIDI再生とMIDI_TIME同期の確認
    - step()構文の動作確認
  
  - [x] 11.3 ヘッドレスモードでの自動テスト
    - ヘッドレスモードでサンプル実行
    - ログ出力の確認
    - タイミング検証

- [x] 12. 最終チェックポイント
  - すべてのテストが通ることを確認
  - サンプルスクリプトが正しく動作することを確認
  - ユーザーに最終確認

## 注意事項

- タスクに`*`が付いているものはオプション（プロパティベーステスト）です
- 各チェックポイントで問題があれば前のタスクに戻って修正します
- Ebitengineの描画APIはメインスレッドでのみ呼び出し可能なため、描画コマンドはキューイングが必要です（描画系実装時に対応）
- macOSではtimeoutコマンドが使用できないため、タイムアウト機能はGo内部で実装します
- MIDI再生はgo-meltysynth + Ebitengine/audioを使用（純粋Go、CGO不要）
- MIDI_TIMEイベント生成はゲームループのUpdate()内でplayer.Position()を使用して正確なタイミングを実現
- 実験コードは`experiments/midi_test/ebiten_midi_v2.go`を参照
