# 要件定義書: スプライトシステム (Sprite System)

## はじめに

このドキュメントは、FILLYエミュレータのグラフィックスシステムを簡素化するためのスプライトシステムの要件を定義します。現在の複雑なレイヤーシステムを、汎用的なスプライトベースのアーキテクチャに置き換えることで、保守性とパフォーマンスを向上させます。

## 背景

### 現在の問題点

1. **複雑なレイヤー管理**: 現在のレイヤーシステムは、PictureLayer、TextLayer、CastLayer、BackgroundLayerなど多くの専用レイヤータイプがあり、管理が複雑
2. **重複したコード**: 各レイヤータイプで位置、可視性、Z順序などの共通機能が重複実装されている
3. **Ebitengineの機能活用不足**: Ebitengineの画像処理機能を十分に活用できていない

### 解決方針

すべての描画要素（ウインドウ、ピクチャ、キャスト、文字、図形）を統一的な「スプライト」として扱い、Ebitengineの機能をラップした汎用的なシステムを構築します。

## 用語集

- **Sprite（スプライト）**: 画像を保持し、位置・Z順序・可視性・透明度を持つ描画単位
- **SpriteManager**: スプライトの作成・管理・描画を行うマネージャー
- **Z順序**: 描画順序。値が小さいほど背面、大きいほど前面に描画される
- **親子関係**: スプライト間の階層関係。子は親の位置・透明度・可視性を継承する
- **差分抽出**: テキスト描画時にアンチエイリアスを除去するための手法

## 要件

### 要件1: 汎用スプライト

**ユーザーストーリー:** 開発者として、すべての描画要素を統一的なスプライトとして扱いたい。そうすることで、コードの重複を減らし、保守性を向上させられる。

#### 受け入れ基準

1.1. THE Sprite SHALL 一意のIDを持つ
1.2. THE Sprite SHALL *ebiten.Image を保持する
1.3. THE Sprite SHALL 位置（X, Y座標）を持つ
1.4. THE Sprite SHALL Z順序を持つ
1.5. THE Sprite SHALL 可視性フラグを持つ
1.6. THE Sprite SHALL 透明度（0.0〜1.0）を持つ
1.7. THE Sprite SHALL 親スプライトへの参照を持つ（オプション）
1.8. THE Sprite SHALL ダーティフラグを持つ

### 要件2: 親子関係

**ユーザーストーリー:** 開発者として、スプライト間に親子関係を設定したい。そうすることで、ウインドウとその内容物の関係を自然に表現できる。

#### 受け入れ基準

2.1. WHEN 子スプライトの絶対位置を計算するとき THEN THE System SHALL 親の位置を加算する
2.2. WHEN 子スプライトの実効透明度を計算するとき THEN THE System SHALL 親の透明度を乗算する
2.3. WHEN 親スプライトが非表示のとき THEN THE System SHALL 子スプライトも非表示として扱う
2.4. THE Sprite SHALL 親を変更できる

### 要件3: スプライトマネージャー

**ユーザーストーリー:** 開発者として、スプライトを一元管理したい。そうすることで、描画順序の管理やスプライトの検索が容易になる。

#### 受け入れ基準

3.1. THE SpriteManager SHALL スプライトを作成できる
3.2. THE SpriteManager SHALL 指定サイズの空のスプライトを作成できる
3.3. THE SpriteManager SHALL IDでスプライトを取得できる
3.4. THE SpriteManager SHALL スプライトを削除できる
3.5. THE SpriteManager SHALL すべてのスプライトをクリアできる
3.6. THE SpriteManager SHALL 登録されているスプライト数を返せる

### 要件4: Z順序による描画

**ユーザーストーリー:** 開発者として、スプライトがZ順序に従って正しく描画されるようにしたい。そうすることで、重なり順を制御できる。

#### 受け入れ基準

4.1. THE SpriteManager SHALL スプライトをZ順序（小さい順）で描画する
4.2. THE SpriteManager SHALL 非表示のスプライトを描画しない
4.3. THE SpriteManager SHALL 親が非表示の子スプライトを描画しない
4.4. THE SpriteManager SHALL 透明度を適用して描画する
4.5. THE SpriteManager SHALL 親子関係を考慮した絶対位置で描画する

### 要件5: テキストスプライト（差分抽出方式）

**ユーザーストーリー:** 開発者として、テキストをアンチエイリアスなしで描画したい。そうすることで、FILLYの見た目を正確に再現できる。

#### 受け入れ基準

5.1. THE System SHALL 背景色の上にテキストを描画し、差分を抽出する
5.2. THE System SHALL 差分抽出結果を透過スプライトとして生成する
5.3. THE System SHALL テキストの色を指定できる
5.4. THE System SHALL 複数のテキストを重ねて描画できる
5.5. WHEN 同じ位置に異なるテキストを描画したとき THEN THE System SHALL 前のテキストの影を残さない

### 要件6: ピクチャスプライト

**ユーザーストーリー:** 開発者として、BMPファイルをスプライトとして表示したい。そうすることで、FILLYのピクチャ機能を実現できる。

#### 受け入れ基準

6.1. THE System SHALL BMPファイルからスプライトを作成できる
6.2. THE System SHALL 透明色を指定できる
6.3. THE System SHALL ピクチャの一部を切り出してスプライトにできる

### 要件7: ウインドウスプライト

**ユーザーストーリー:** 開発者として、仮想ウインドウをスプライトとして表現したい。そうすることで、ウインドウとその内容物を親子関係で管理できる。

#### 受け入れ基準

7.1. THE System SHALL 指定サイズ・背景色のウインドウスプライトを作成できる
7.2. THE System SHALL ウインドウスプライトを親として子スプライトを追加できる
7.3. WHEN ウインドウが閉じられたとき THEN THE System SHALL ウインドウとその子スプライトを削除する

### 要件8: キャストスプライト

**ユーザーストーリー:** 開発者として、キャスト（アニメーションスプライト）を表現したい。そうすることで、FILLYのキャスト機能を実現できる。

#### 受け入れ基準

8.1. THE System SHALL キャストをスプライトとして作成できる
8.2. THE System SHALL キャストの位置を移動できる（残像なし）
8.3. THE System SHALL キャストを削除できる
8.4. THE System SHALL 透明色処理をサポートする

### 要件9: 図形スプライト

**ユーザーストーリー:** 開発者として、図形（線、矩形、円など）をスプライトとして描画したい。そうすることで、FILLYの描画機能を実現できる。

#### 受け入れ基準

9.1. THE System SHALL 線を描画したスプライトを作成できる
9.2. THE System SHALL 矩形を描画したスプライトを作成できる
9.3. THE System SHALL 塗りつぶし矩形を描画したスプライトを作成できる

### 要件10: パフォーマンス

**ユーザーストーリー:** 開発者として、スプライトシステムが効率的に動作するようにしたい。そうすることで、60FPSでのスムーズな描画を維持できる。

#### 受け入れ基準

10.1. THE SpriteManager SHALL Z順序のソート結果をキャッシュする
10.2. THE SpriteManager SHALL スプライトの変更時にソートが必要であることをマークする
10.3. THE System SHALL スレッドセーフな操作を提供する

