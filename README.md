# son-et
FILLY Script Interpreter

## 概要

son-etは、レガシーなFILLYスクリプト(Toffyスクリプト)を直接実行するインタプリタです。
開発時は即座にスクリプトを実行でき、配布時はプロジェクトを埋め込んだスタンドアロン実行ファイルを作成できます。
クロスプラットフォームのため全ての機能を実現することはできず、FILLYのサブセットとなっています。

※FILLYの仕様を十分に把握できていないことや、FILLYのターゲットであるWindowsではなくMacで開発しているために再現できない機能もあります。

## 特徴

*   **インタプリタ実行**: FILLYスクリプト（`.tfy`など）を直接実行します。コンパイル不要で即座に動作確認が可能です。
*   **シングルバイナリ配布**: 画像や音楽（MIDI）などのリソースファイルを埋め込んだスタンドアロン実行ファイルを生成できます。
*   **クロスプラットフォーム対応**: macOSを含む主要なプラットフォームで動作します。※ただし現段階ではmacOSでのみ動作確認を行なっています。
*   **MIDI/Audio対応**: MIDIファイル(SMF)の再生をサポートしており、ソフトウェアシンセサイザーにより外部音源なしでBGMを再生可能です。(ただし、MIDIを再生する場合は別途SF2ファイルが必要です。)

## プロジェクト構造

```
son-et/
├── cmd/son-et/          # エントリーポイント
│   ├── main.go
│   ├── soundfonts/      # SoundFont配置ディレクトリ
│   └── titles/          # 埋め込みタイトル配置ディレクトリ
├── pkg/
│   ├── app/             # アプリケーション初期化・起動
│   ├── cli/             # コマンドライン引数解析
│   ├── compiler/        # TFYスクリプトコンパイラ
│   │   ├── preprocessor/  # プリプロセッサ
│   │   ├── lexer/         # 字句解析
│   │   ├── parser/        # 構文解析
│   │   └── compiler/      # OpCode生成
│   ├── fileutil/        # ファイルシステムユーティリティ
│   ├── graphics/        # グラフィックスシステム
│   │   ├── graphics_core.go     # コアシステム（構造体定義、初期化、更新）
│   │   ├── graphics_draw.go     # 描画ロジック（座標変換、テキスト、図形）
│   │   ├── graphics_window.go   # ウィンドウ管理（開閉、移動、タイトル）
│   │   ├── graphics_sprite.go   # スプライト管理（キャスト配置、移動、削除）
│   │   ├── color_utils.go       # 色変換ユーティリティ
│   │   ├── sprite_sort.go       # スプライトソートユーティリティ
│   │   └── ...                  # スプライト、ピクチャー、ウィンドウ等の型定義
│   ├── logger/          # ログ出力
│   ├── opcode/          # OpCode定義
│   ├── script/          # スクリプトファイル読み込み
│   ├── sprite/          # スプライトシステム
│   ├── title/           # タイトル管理
│   ├── vm/              # 仮想マシン（VM）
│   │   ├── vm.go                # VMコア（構造体定義、実行ループ）
│   │   ├── builtins_math.go     # 数学関数（Random等）
│   │   ├── builtins_string.go   # 文字列操作（StrPrint, SubStr等）
│   │   ├── builtins_array.go    # 配列操作
│   │   ├── builtins_graphics.go # グラフィックス関数（LoadPic, OpenWin等）
│   │   ├── builtins_audio.go    # オーディオ関数（PlayMIDI, PlayWAVE）
│   │   ├── builtins_system.go   # システム関数（Wait, Debug等）
│   │   └── audio/               # オーディオサブシステム
│   └── window/          # ウィンドウシステム
└── docs/                # ドキュメント
```

## 動作環境

*   **Go**: バージョン 1.24 以上

## インストール

```bash
git clone https://github.com/zurustar/son-et.git
cd son-et
go install ./cmd/son-et
```

`son-et` コマンドが `$GOPATH/bin` にインストールされます。パスが通っていることを確認してください。

## 使い方

### 基本的な使い方

```bash
# 外部タイトルを実行
son-et /path/to/title

# タイムアウトを指定（10秒後に自動終了）
son-et --timeout 10 /path/to/title

# ヘッドレスモードで実行（GUIなし）
son-et --headless /path/to/title

# ログレベルを指定
son-et --log-level debug /path/to/title

# 複数のオプションを組み合わせ（順序は自由）
son-et /path/to/title --timeout 5 --headless --log-level debug
```

### コマンドラインオプション

- `-t, --timeout <seconds>`: 指定秒数後にプログラムを終了（デフォルト: 無制限）
- `-l, --log-level <level>`: ログレベル: debug, info, warn, error（デフォルト: info）
- `--headless`: ヘッドレスモード（GUIなし）
- `-h, --help`: ヘルプを表示


### ビルド手順

```bash
# ソースコードからビルド
go build -o son-et cmd/son-et/main.go

# 実行
./son-et /path/to/title
```

### 開発時（Direct Mode）

プロジェクトディレクトリを指定して直接実行します：

```bash
son-et <プロジェクトディレクトリ>
```

son-etは自動的にディレクトリ内のTFYファイルからmain関数を探して実行します。

**実行の流れ:**
1. 指定されたディレクトリ内のTFYファイルを検索
2. main関数を含むファイルを特定
3. スクリプトをOpCodeに変換（実行時）
4. 同じディレクトリ内のアセット（BMP、MIDI、WAVファイル）を自動検出
5. プログラムを実行

#### ヘッドレスモード（テスト・デバッグ用）

GUIウィンドウを開かずにスクリプトを実行できます。テストやデバッグに便利です：

```bash
son-et --headless --timeout 5 <プロジェクトディレクトリ>
```

**オプション:**
- `--headless`: GUIなしで実行（すべてのログが標準出力に表示されます）
- `--timeout <seconds>`: 指定秒数後に自動終了（例: `5`, `10`, `30`）
- 環境変数 `HEADLESS=1` でもヘッドレスモードを有効化できます

**ヘッドレスモードの特徴:**
- GUIウィンドウが開かない
- 描画操作（OpenWin、PutCast、MoveCastなど）はスキップされるがログに記録される
- スクリプトロジック（タイミング、オーディオ、状態変更）は通常通り実行される
- すべてのログにタイムスタンプが付与され、タイミングの検証が容易
- Kiroなどの自動化環境でのテストに最適

**使用例:**
```bash
# 5秒間ヘッドレスで実行してログを確認
son-et --headless --timeout 5 <プロジェクトディレクトリ>

# ログをファイルに保存
son-et --headless --timeout 5 <プロジェクトディレクトリ> > test.log 2>&1

# 環境変数を使用
HEADLESS=1 son-et --timeout 3 <プロジェクトディレクトリ>
```

**オーディオの動作:**
ヘッドレスモードでは：
- オーディオシステムは完全に初期化されます（MIDI_TIME同期に必要）
- すべてのオーディオ再生（MIDIとWAV）はミュート（音量=0）されます
- MIDIタイミングイベントは正常に発火し、mes(MIDI_TIME)ブロックが正しく動作します
- 音声出力はありませんが、タイミング動作は通常モードと同一です

これにより、MIDI_TIMEモードを使用するスクリプトがヘッドレステストで正しく動作することが保証されます。

**タイムスタンプ付きログ:**
ヘッドレスモードでは、すべての重要なログにタイムスタンプ（`[HH:MM:SS.mmm]`形式）が付与されます：

```
[19:43:20.577] VM: Wait(2 steps) -> 24 ticks
[19:43:20.992] VM: Executing [3] Call (Tick 26) [Seq 0]
```

これにより、mes(TIME)のタイミングが正確に動作しているか、Wait()が指定時間だけ待機しているかを簡単に検証できます。

### 配布時（Embedded Mode）

プロジェクトを埋め込んだスタンドアロン実行ファイルを作成できます。

**ビルド手順:**

ビルドスクリプトを使用してプロジェクトを埋め込みます：

```bash
./scripts/build-embedded.sh <プロジェクトディレクトリ> [実行ファイル名]
```

**例:**
```bash
# プロジェクトを埋め込んだ実行ファイルを作成
./scripts/build-embedded.sh samples/my_project my_project

# 生成された実行ファイルを実行
./bin/my_project

# ヘッドレスモードで実行
./bin/my_project --headless --timeout 5
```

**Embedded Modeの特徴:**
*   TFYスクリプトがビルド時に実行ファイルに埋め込まれます
*   アセットファイル（画像、音楽）も実行ファイルに埋め込まれます
*   配布先でTFYファイルやアセットファイルを別途用意する必要がありません
*   引数なしで実行可能（プロジェクトディレクトリの指定不要）
*   ただし、MIDIを再生する場合はSoundFont（.sf2）ファイルが別途必要です

**ビルドの仕組み:**
1. ビルドスクリプトがプロジェクトファイルを一時ディレクトリにコピー
2. Goの`embed`パッケージを使用してファイルを埋め込み
3. ビルド後、一時ファイルを自動削除
4. 生成された実行ファイルは`bin/`ディレクトリに配置されます

## 画面表示について

son-etは1024x768ピクセルの仮想デスクトップを作成します。FILLYスクリプトは、この仮想デスクトップ内に仮想ウィンドウとして表示されます。

**仮想デスクトップの仕組み:**
*   固定サイズ: 1024x768ピクセル
*   レガシーコンテンツは1:1のピクセル比率で表示（スケーリングなし）
*   複数のウィンドウを同時に表示可能
*   ウィンドウは作成順に重ね合わせ表示（後から作成したものが上に表示）

## アセットファイルについて

### 必要なファイル

**画像ファイル（BMP）:**
*   LoadPic関数で読み込まれる画像ファイル
*   TFYスクリプトと同じディレクトリに配置
*   ファイル名の大文字小文字は区別されません（Windows 3.1互換）

**音楽ファイル（MIDI）:**
*   PlayMIDI関数で再生されるMIDIファイル
*   TFYスクリプトと同じディレクトリに配置
*   再生にはSoundFont（.sf2）ファイルが必要

**効果音ファイル（WAV）:**
*   PlayWAVE関数で再生される音声ファイル
*   TFYスクリプトと同じディレクトリに配置
*   複数のWAVファイルを同時再生可能

### SoundFontについて

MIDIファイルを再生するには、楽器音源を含むSoundFont（.sf2）ファイルが必要です。別途用意してください。

**配置場所:**
*   実行ファイルと同じディレクトリに配置

## サポートされていない機能

クロスプラットフォーム対応のため、以下のWindows専用機能およびレガシーハードウェア依存機能はサポートされていません：

**レガシーハードウェア依存:**
*   **CD Audio再生（PlayCD）**: 物理CD-ROMドライブが必要なため非対応。代わりにMIDIまたはWAVファイルを使用してください。

**Windows専用API:**
*   **MCI Commands（MCI、StrMCI）**: Windows Media Control Interfaceは非対応。代わりにPlayMIDI、PlayWAVE、PlayAVIを使用してください。
*   **Windowsレジストリアクセス（SetRegStr、GetRegStr）**: 非対応。代わりにINIファイル（WriteIniInt、GetIniInt等）を使用してください。

**その他:**
*  仕様がわからず予想で実装している箇所が多数あります。
*  特にMovePic関数のシーンチェンジのパラメータは何が何を表しているのか全くわかっていません

これらの機能を使用しているスクリプトは、上記の代替機能を使用するように修正が必要です。

## トラブルシューティング

### プログラムが起動しない

*   Goのバージョンが1.24以上であることを確認してください
*   `son-et --help` でヘルプが表示されるか確認してください

### 画像が表示されない

*   BMPファイルがTFYスクリプトと同じディレクトリにあることを確認
*   ファイル名が正しいか確認（大文字小文字は区別されません）

### MIDIが再生されない

*   SoundFont（.sf2）ファイルがカレントディレクトリに配置されているか確認
*   MIDIファイルがTFYスクリプトと同じディレクトリにあることを確認

### 音が出ない

*   システムの音量設定を確認
*   他のアプリケーションで音が出るか確認
*   macOSの場合、オーディオ出力デバイスの設定を確認

## 謝辞

FILLYの作者である内田友幸さん、FILLYタイトルの作者の皆様、FILLYを盛り上げたFFILLYのコミュニティの皆様方に感謝申し上げます。

